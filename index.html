<!DOCTYPE html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>

<style>
div.tooltip {	
    position: absolute;			
    text-align: left;			
    padding: 2px;
    width: 250px;
    font: 12px sans-serif;		
    background: lightsteelblue;	
    border: 0px;		
    border-radius: 8px;			
    pointer-events: none;}
</style>

<body onload='init()'>  
<svg width=1500 height=700>
</svg>
<script>   
    
   d3.select('svg').append('text')
     .attr('x', 00)
     .attr('y', 19)
     .attr('stroke', 'green')
     .style("font-size", 30)
     .text("The Rise and Fall of The Simpsons")
    
    d3.select('svg').append('text')
      .attr('x', 00)
      .attr('y', 30)
      .attr('stroke', 'black')
      .style("font-size", 19)
      .text("The Simpsons was a good show but now it is bad. Here's how it happened.")
    
   d3.select('svg').append('text')
     .attr
     .attr('x', 300)
     .attr('y', 169)
     .attr('stroke', 'black')
     .style("font-size", 19)
     .text("Begin")
 
  async function init() {
     
    const seas = await d3.csv("https://raw.githubusercontent.com/AlexZurski/NarrativeViz/main/SimpsonAverage.csv"); 
     
    const x2 = d3.scaleLinear().domain([0.75, 31]).range([0, 1400]);
    const xaxis2 = d3.axisBottom(x2).tickValues([5, 10, 15, 20, 25, 30]).tickFormat(d3.format("~s"));
  
    const y = d3.scaleLinear().domain([4, 9]).range([600, 100]);
    const yaxis = d3.axisLeft(y).tickValues([4, 5, 6, 7, 8, 9]).tickFormat(d3.format("~s"));
    
    var line = d3.line()
    .x(function(d) { return x2(d["Season"]); })
    .y(function(d) { return y(d["Rating"]); })
     
    d3.select('svg').append("g").attr("transform", "translate(" + 50 + "," + 75 + ")")
      .selectAll('path').data(seas).enter().append("path")
      .datum(seas)
      .attr("fill", "none")
      .attr("stroke", "steelblue")
      .attr("stroke-width", 2)
      .attr("d", line);
     
    d3.select('svg').append('g').attr("transform", "translate(" + 50 + "," + 75 + ")");
    d3.select("svg").append("g").attr("transform", "translate(" + 50 + "," + 50 + ")").call(yaxis);
    d3.select("svg").append("g").attr("transform", "translate(" + 50 + "," + 650 + ")").call(xaxis2);
      
      
    d3.select('svg').append('rect')
      .attr('x', 300)
      .attr('y', 100)
      .attr('width', 100)
      .attr('height', 50)
      .attr('stroke', 'black')
      .attr('fill', 'green')
      .on("click", step1);

  };
   
  async function step1() {
      
   d3.select('svg").selectAll('rect').remove();
     
   const seas = await d3.csv("https://raw.githubusercontent.com/AlexZurski/NarrativeViz/main/SimpsonAverage.csv");
     
   const x2 = d3.scaleLinear().domain([0.75, 31]).range([0, 1400]);
   const y = d3.scaleLinear().domain([4, 9]).range([600, 100]);
     
   d3.select('svg').append("g").attr("transform", "translate(" + 50 + "," + 75 + ")")
    .selectAll("circle").data(seas).enter().append("circle")
    //.filter(function(d, i) { return i == 0 })
    .attr("fill", "lightblue")
    .attr("stroke", "black")
    .attr("cx", function(d) { return x2(d["Season"]) })
    .attr("cy", function(d) { return y(d["Rating"]) })
    .attr("r", 5)
  
    const annotation1 = [{ note: {
                          label: "The Simpsons debuts on the Fox network",
                          title: "Season 1"},
                          type: d3.annotationCalloutCircle,
                          subject: {
                          radius: 7,         
                          radiusPadding: 7},
                          color: "black",
                          x: 11.57024793,
                          y: 223.0769231,
                          dy: 20,
                          dx: 0}]

    const makeAnnotations = d3.annotation()
                              .annotations(annotation1)

    d3.select("svg").append("g").attr("transform", "translate(" + 50 + "," + 75 + ")")
      .call(makeAnnotations)
      
  d3.select('svg').append('rect')
     .attr('x', 400)
     .attr('y', 100)
     .attr('width', 100)
     .attr('height', 50)
     .attr('stroke', 'black')
     .attr('fill', 'red')
     .on("click", step2)
      
  }
   
async function step2() {
    
   d3.select('svg").selectAll('rect').remove();
     
   const seas = await d3.csv("https://raw.githubusercontent.com/AlexZurski/NarrativeViz/main/SimpsonAverage.csv");
     
   const x2 = d3.scaleLinear().domain([0.75, 31]).range([0, 1400]);
   const y = d3.scaleLinear().domain([4, 9]).range([600, 100]);
     
   d3.select('svg').append("g").attr("transform", "translate(" + 50 + "," + 75 + ")")
    .selectAll("circle").data(seas).enter().append("circle")
    //.filter(function(d, i) { return i == 1 })
    .attr("fill", "lightblue")
    .attr("stroke", "black")
    .attr("cx", function(d) { return x2(d["Season"]) })
    .attr("cy", function(d) { return y(d["Rating"]) })
    .attr("r", 5)
    
  const annotation2 = [{ note: {
                          label: "Bart Simpson appears on the cover of TIME",
                          title: "Season 2"},
                          type: d3.annotationCalloutCircle,
                          subject: {
                          radius: 7,         
                          radiusPadding: 7},
                          color: "black",
                          x: 57.85123967,
                          y: 195,
                          dy: -45,
                          dx: 0}]

    const makeAnnotations = d3.annotation()
                              .annotations(annotation2)

    d3.select("svg").append("g").attr("transform", "translate(" + 50 + "," + 75 + ")")
      .call(makeAnnotations)
    
   d3.select('svg').append('rect')
     .attr('x', 500)
     .attr('y', 100)
     .attr('width', 100)
     .attr('height', 50)
     .attr('stroke', 'black')
     .attr('fill', 'blue')
     .on("click", full)
   
  }

  async function full() {
     
    d3.select('svg").selectAll('rect').remove(); 
      
    const epis = await d3.csv("https://raw.githubusercontent.com/AlexZurski/NarrativeViz/main/SimpsonData.csv");
      
    var div = d3.select("body").append("div")	
                 .attr("class", "tooltip");
                

     
    const x = d3.scaleLinear().domain([1, 683]).range([0, 1400]);
    const xaxis = d3.axisBottom(x).tickValues([100, 200, 300, 400, 500, 600]).tickFormat(d3.format("~s"));
    const y = d3.scaleLinear().domain([4, 9]).range([600, 100]);
     
    d3.select('svg').append("g").attr("transform", "translate(" + 50 + "," + 75 + ")")
       .selectAll('circle').data(epis).enter().append('circle')
       .attr("fill", "lightblue")
       .attr("stroke", "black")
       .attr("opacity", 0.0)
       .attr("cx", function(d) { return x(d["Episode"]); })
       .attr("cy", function(d) { return y(d["Rating"]); })
       .attr("r", 2)
       .on("mouseover", function(d) {		
            div.transition()		
               .duration(200)		
               .style("opacity", .9);		
            div.html("Season: " + d["Season"] + "<br/>" + 
                    "Episode: " + d["Episode"] + "<br/>" +
                    "Title: " + d["Title"] + "<br/>" +
                    "Rating: " + d["Rating"] + "<br/>" +
                    d["Description"])
               .style("left", (d3.event.pageX - (d3.event.pageX / 1500) * 250) + "px")		
               .style("bottom", (725 - d3.event.pageY) + "px");
            })
       .on("mouseout", function(d) {		
            div.transition()		
                .duration(500)		
                .style("opacity", 0);	
        });
     
    d3.select('svg').selectAll('circle')
       .transition()
       .delay(function(d,i) { return (i*15); })
       .duration(1)
       .attr("opacity", 1);
    
    d3.select("svg").append("g").attr("transform", "translate(" + 50 + "," + 600 + ")").call(xaxis);
  }
   
 </script>
 </body>
